# Better Auth Setup - Phase 3 Completion Steps

## Current Status

✅ **PHASE 3 COMPLETE** - User Registration is fully functional!

**All Setup Complete**:
- ✅ Better Auth dependencies installed (better-auth, pg, @types/pg)
- ✅ Auth configuration created in `lib/auth/auth.ts`
- ✅ API route handler configured in `app/api/auth/[...betterauth]/route.ts`
- ✅ Client-side auth helper created in `lib/auth/client.ts`
- ✅ SignupForm updated to use Better Auth client
- ✅ Environment variables configured in `.env.local`
- ✅ Database connection established to Neon PostgreSQL
- ✅ Better Auth database schema migrated successfully
- ✅ Dashboard page created for post-signup redirect

**Database Tables Created**:
- `user` - User accounts (email, password, etc.)
- `session` - Active sessions
- `account` - OAuth provider accounts
- `verification` - Email verification tokens

---

## Testing the Signup Flow

### 1. Start the Frontend Dev Server

```bash
cd frontend
npm run dev
```

The app will be available at `http://localhost:3000`

### 2. Test User Registration

1. **Navigate to signup page**: `http://localhost:3000/signup`
2. **Fill out the form**:
   - Email: `test@example.com`
   - Password: `testpass123` (minimum 8 characters)
   - Confirm Password: `testpass123`
3. **Submit the form**
4. **Expected behavior**:
   - User is created in the database
   - User is automatically logged in
   - Redirected to `/dashboard`
   - Dashboard shows welcome message with your email

### 3. Verify in Database

Check your Neon PostgreSQL database to see the created user:

```sql
SELECT id, email, "createdAt", "emailVerified" FROM "user";
SELECT id, "userId", "expiresAt", "createdAt" FROM "session";
```

### 4. Test Error Scenarios

**Duplicate Email**:
- Try signing up with the same email again
- Should show: "Email already exists. Please use a different email or log in."

**Password Mismatch**:
- Enter different values for password and confirm password
- Should show validation error: "Passwords do not match"

**Invalid Email**:
- Enter invalid email format (e.g., "notanemail")
- Should show: "Invalid email address"

**Short Password**:
- Enter password less than 8 characters
- Should show: "Password must be at least 8 characters"

---

## Environment Variables Reference

**Required Variables** (in `frontend/.env.local`):

```bash
# Backend API
NEXT_PUBLIC_API_URL=http://localhost:8000

# Better Auth (must match backend JWT_SECRET_KEY for token validation)
BETTER_AUTH_SECRET=a846e4a233fa6aa184242bafa076cad1633fbec39fdc101fe3cd9eff7649c97b
JWT_SECRET_KEY=a846e4a233fa6aa184242bafa076cad1633fbec39fdc101fe3cd9eff7649c97b
BETTER_AUTH_URL=http://localhost:3000
NEXT_PUBLIC_BETTER_AUTH_URL=http://localhost:3000

# Database (Neon PostgreSQL - same as backend)
DATABASE_URL=<YOUR_ACTUAL_NEON_CONNECTION_STRING>
```

**Important Notes**:
- `BETTER_AUTH_SECRET` and `JWT_SECRET_KEY` must match the backend's `JWT_SECRET_KEY`
- This ensures JWT tokens generated by Better Auth can be validated by the backend
- The DATABASE_URL should point to your Neon PostgreSQL instance

---

## Better Auth Endpoints

Once configured, Better Auth provides these endpoints automatically:

- `POST /api/auth/sign-up/email` - User registration
- `POST /api/auth/sign-in/email` - User login
- `POST /api/auth/sign-out` - User logout
- `GET /api/auth/get-session` - Get current session

**Note**: The SignupForm component is configured to use `authClient.signUp.email()` which calls the sign-up endpoint internally.

---

## Troubleshooting

### Error: "connect ECONNREFUSED"
- **Cause**: DATABASE_URL is not configured or points to an invalid host
- **Fix**: Update `.env.local` with your actual Neon PostgreSQL connection string

### Error: "JWT_SECRET_KEY not configured"
- **Cause**: Environment variables not loaded
- **Fix**: Ensure `.env.local` exists and contains all required variables

### Error: "Email already exists"
- **Cause**: User with that email already registered
- **Fix**: Use a different email or check the `user` table in your database

### Better Auth tables not created
- **Cause**: CLI migrations not run
- **Fix**: Run `npx @better-auth/cli@latest migrate --config lib/auth/auth.ts`

---

## Database Schema

Better Auth will create the following tables in your Neon PostgreSQL database:

1. **user** - Stores user accounts (id, email, password hash, etc.)
2. **session** - Stores active user sessions
3. **account** - Stores OAuth provider accounts (if social login is enabled)
4. **verification** - Stores email verification tokens (if email verification is enabled)

**For MVP**: We're only using email/password auth with `requireEmailVerification: false`, so only `user` and `session` tables are actively used.

---

## Phase 3 Acceptance Criteria

Once the above steps are complete, verify:

- ✅ User can access signup page at `/signup`
- ✅ Form validates email format and password length (min 8 chars)
- ✅ Passwords must match (password and confirmPassword fields)
- ✅ Successful signup creates user in database
- ✅ Successful signup auto-logs in user and redirects to `/dashboard`
- ✅ Duplicate email shows error: "Email already exists"
- ✅ JWT token is stored in httpOnly cookie
- ✅ Session persists across page reloads

---

## Next Phase: User Login (Phase 4)

After Phase 3 is complete, you'll implement:
- LoginForm component
- Login page at `/login`
- Session persistence and protected routes
- Logout functionality

See `specs/004-frontend-nextjs/tasks.md` for Phase 4 tasks.

---

## References

- [Better Auth Documentation](https://www.better-auth.com/docs/installation)
- [Better Auth Next.js Integration](https://www.better-auth.com/docs/integrations/next-js)
- [Neon PostgreSQL Documentation](https://neon.tech/docs)
